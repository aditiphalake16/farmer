<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farming Support System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #1a5d1a;
            --light-green: #4a7c59;
            --accent-green: #7fb069;
            --bright-green: #90ee90;
            --earthy-brown: #8b4513;
            --warm-yellow: #ffd700;
            --orange-accent: #ff8c00;
            --cream-white: #faf8f3;
            --soft-beige: #f5f5dc;
            --card-shadow: 0 8px 32px rgba(0,0,0,0.12);
            --hover-shadow: 0 16px 48px rgba(0,0,0,0.18);
            --gradient-primary: linear-gradient(135deg, #1a5d1a 0%, #4a7c59 100%);
            --gradient-accent: linear-gradient(135deg, #7fb069 0%, #90ee90 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--cream-white) 0%, #f0f8e8 50%, var(--soft-beige) 100%);
            color: #333;
            line-height: 1.7;
            overflow-x: hidden;
        }

        /* Enhanced background with farming patterns */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(127, 176, 105, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 69, 19, 0.05) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Enhanced navigation with modern glass effect */
        .navbar {
            background: linear-gradient(135deg, 
                rgba(34, 139, 34, 0.95) 0%, 
                rgba(46, 125, 50, 0.95) 50%, 
                rgba(27, 94, 32, 0.95) 100%);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        /* Enhanced logo icon with pulse animation */
        .logo i {
            font-size: 2rem;
            background: linear-gradient(45deg, #4CAF50, #8BC34A, #CDDC39);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 0.5rem;
            margin: 0;
            padding: 0;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Modern hover effects with glow */
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .nav-links a i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .nav-links a:hover i {
            transform: scale(1.2);
        }

        /* Enhanced hero section with farming imagery */
        .hero {
            background: 
                linear-gradient(rgba(26, 93, 26, 0.8), rgba(74, 124, 89, 0.7)), 
                url('/placeholder.svg?height=800&width=1400') center/cover;
            height: 85vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        /* Floating farming elements */
        .hero::before {
            content: 'üåæ üöú üå± üåΩ üçÖ ü•ï';
            position: absolute;
            top: 10%;
            left: -100%;
            font-size: 3rem;
            animation: float 20s linear infinite;
            opacity: 0.3;
        }

        .hero::after {
            content: 'üåª üåø üçÉ üåæ üöú üå±';
            position: absolute;
            bottom: 10%;
            right: -100%;
            font-size: 2.5rem;
            animation: float-reverse 25s linear infinite;
            opacity: 0.3;
        }

        @keyframes float {
            from { left: -100%; }
            to { left: 100%; }
        }

        @keyframes float-reverse {
            from { right: -100%; }
            to { right: 100%; }
        }

        .hero-content h1 {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: fadeInUp 1s ease;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            font-weight: 700;
        }

        .hero-content p {
            font-size: 1.5rem;
            margin-bottom: 2.5rem;
            animation: fadeInUp 1s ease 0.2s both;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 400;
        }

        .cta-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            animation: fadeInUp 1s ease 0.4s both;
        }

        .btn {
            padding: 1.2rem 2.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        /* Enhanced button styles with farming theme */
        .btn-primary {
            background: var(--warm-yellow);
            color: var(--primary-green);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:hover {
            background: var(--orange-accent);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 140, 0, 0.5);
        }

        .btn-secondary {
            background: transparent;
            color: white;
            border: 3px solid white;
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: white;
            color: var(--primary-green);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 255, 255, 0.4);
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .section {
            display: none;
            animation: fadeIn 0.6s ease;
        }

        .section.active {
            display: block;
        }

        /* Enhanced section titles with farming icons */
        .section-title {
            font-size: 3rem;
            color: var(--primary-green);
            margin-bottom: 3rem;
            text-align: center;
            position: relative;
            font-weight: 700;
        }

        .section-title::before {
            content: 'üåæ';
            position: absolute;
            left: -60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5rem;
            animation: bounce 2s ease-in-out infinite;
        }

        .section-title::after {
            content: 'üåæ';
            position: absolute;
            right: -60px;
            top: 50%;
            transform: translateY(-50%) scaleX(-1);
            font-size: 2.5rem;
            animation: bounce 2s ease-in-out infinite 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-60%) scale(1.1); }
        }

        /* Enhanced cards with farming theme */
        .card {
            background: linear-gradient(145deg, white 0%, #fafafa 100%);
            border-radius: 20px;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(127, 176, 105, 0.2);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-accent);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent-green);
        }

        .card h3 {
            color: var(--primary-green);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        /* Add farming icons to card titles */
        .card h3::before {
            content: 'üå±';
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8rem;
            color: var(--primary-green);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Enhanced form inputs with farming theme */
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.2rem;
            border: 2px solid #e8f5e8;
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, white 0%, #fafafa 100%);
            font-family: 'Poppins', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 4px rgba(127, 176, 105, 0.2);
            transform: translateY(-2px);
        }

        /* Grid Layouts */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2.5rem;
            margin-top: 2.5rem;
        }

        /* Enhanced profile cards with Indian farming theme */
        .profile-card {
            background: linear-gradient(145deg, white 0%, #f8fdf8 100%);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(127, 176, 105, 0.1);
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(127, 176, 105, 0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.4s ease;
        }

        .profile-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent-green);
        }

        .profile-card:hover::before {
            transform: rotate(45deg) scale(1.2);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 8px 25px rgba(127, 176, 105, 0.4);
            position: relative;
            z-index: 1;
        }

        .profile-card h3 {
            font-size: 1.5rem;
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .profile-card p {
            margin-bottom: 0.8rem;
            color: #666;
            font-weight: 500;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .profile-card p i {
            color: var(--accent-green);
            width: 20px;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 1rem 1.5rem;
            border: 2px solid #e8f5e8;
            border-radius: 30px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 4px rgba(127, 176, 105, 0.2);
        }

        .filter-select {
            padding: 1rem 1.5rem;
            border: 2px solid #e8f5e8;
            border-radius: 30px;
            background: white;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 4px rgba(127, 176, 105, 0.2);
        }

        /* Compact query list styling */
        .query-card {
            background: linear-gradient(145deg, white 0%, #f8fdf8 100%);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            border: 1px solid rgba(127, 176, 105, 0.15);
            padding: 1rem;
        }

        .query-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent-green);
        }

        .query-list { display: flex; flex-direction: column; gap: .75rem; }
        .query-card--compact { display: grid; grid-template-columns: 72px 1fr; gap: 1rem; align-items: center; }
        .query-thumb { width: 72px; height: 72px; border-radius: 10px; background: #eef6ee; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        .query-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .query-meta-small { display:flex; gap:.5rem; align-items:center; margin-bottom:.25rem; color:#5a7a5a; font-size:.85rem; }
        .badge { display:inline-block; padding:.2rem .6rem; border-radius:12px; font-size:.75rem; font-weight:600; }
        .badge-expert { background:#fff3cd; color:#8a6d3b; border:1px solid #ffe08a; }
        .badge-crop { background:#e8f5e8; color:#1a5d1a; border:1px solid #cfe9cf; }
        .query-title-small { font-size:1rem; color:#1a3d1a; font-weight:700; margin:0; }
        .query-subtitle { font-size:.9rem; color:#555; margin-top:.15rem; }

        .query-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .query-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/placeholder.svg?height=250&width=400') center/cover;
            opacity: 0.8;
        }

        .query-content {
            padding: 2rem;
        }

        /* Square response items under each query */
        .response-item {
            text-align: left;
            margin: 0.5rem 0;
            padding: 0.8rem 1rem;
            border: 1px solid #e0e7e0;
            border-radius: 8px;
            background: #ffffff;
        }

        /* Mini squares grid like farmer cards */
        .mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .mini-card {
            background: #ffffff;
            border: 1px solid #e8f5e8;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            overflow: hidden;
        }

        .mini-card h5 {
            color: var(--primary-green);
            font-size: 1rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .mini-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .query-content h4 {
            font-size: 1.4rem;
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .query-tags {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .tag {
            background: var(--gradient-accent);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(127, 176, 105, 0.3);
        }

        /* Equipment Cards */
        .equipment-card {
            background: linear-gradient(145deg, white 0%, #f8fdf8 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(127, 176, 105, 0.1);
        }

        .equipment-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent-green);
        }

        .equipment-image {
            width: 100%;
            height: 220px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3.5rem;
            position: relative;
        }

        .equipment-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/placeholder.svg?height=220&width=350') center/cover;
            opacity: 0.9;
        }

        .equipment-info {
            padding: 2rem;
        }

        .equipment-info h4 {
            font-size: 1.4rem;
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 1rem;
        }

        .status-available {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            box-shadow: 0 4px 15px rgba(21, 87, 36, 0.2);
        }

        .status-unavailable {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            box-shadow: 0 4px 15px rgba(114, 28, 36, 0.2);
        }

        /* Enhanced reviews with Indian farming context */
        .review-card {
            background: linear-gradient(145deg, white 0%, #f8fdf8 100%);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(127, 176, 105, 0.1);
            position: relative;
        }

        .review-card::before {
            content: '"';
            position: absolute;
            top: -10px;
            left: 20px;
            font-size: 4rem;
            color: var(--accent-green);
            opacity: 0.3;
            font-family: serif;
        }

        .review-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent-green);
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(127, 176, 105, 0.3);
        }

        .stars {
            color: var(--warm-yellow);
            font-size: 1.4rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .stars i {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stars i:hover {
            transform: scale(1.2);
        }

        /* Mobile menu styling */
        .mobile-menu {
            display: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .mobile-menu:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .hero-content h1 {
                font-size: 2.8rem;
            }

            .hero-content p {
                font-size: 1.2rem;
            }

            .section-title {
                font-size: 2.2rem;
            }

            .section-title::before,
            .section-title::after {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .search-filter {
                flex-direction: column;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive navigation */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .mobile-menu {
                display: block;
            }
            
            .nav-container {
                padding: 0 1rem;
            }
            
            .logo {
                font-size: 1.5rem;
            }
        }

        /* Add loading animation for better UX */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Updated navigation with English-only branding -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-seedling"></i>
                FarmSupport Pro
            </div>
            <ul class="nav-links">
                <li><a href="#" onclick="showSection('home')" class="active"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" onclick="showSection('farmers')"><i class="fas fa-users"></i> Farmers</a></li>
                <li><a href="#" onclick="showSection('crops')"><i class="fas fa-leaf"></i> Crops</a></li>
                <li><a href="#" onclick="showSection('queries')"><i class="fas fa-question-circle"></i> Queries</a></li>
                <li><a href="#" onclick="showSection('equipment')"><i class="fas fa-tractor"></i> Equipment</a></li>
                <li><a href="#" onclick="showSection('lending')"><i class="fas fa-handshake"></i> Lending</a></li>
                <li><a href="#" onclick="showSection('reviews')"><i class="fas fa-star"></i> Reviews</a></li>
                <li><a id="authNavLink" href="#" onclick="showSection('auth')"><i class="fas fa-user-circle"></i> Login</a></li>
            </ul>
            <div class="mobile-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="section active">
        <div class="hero">
            <div class="hero-content">
                <h1>üåæ Farming Support System üåæ</h1>
                <p>Connecting Indian farmers, sharing knowledge, and growing together</p>
                <div class="cta-buttons">
                    <a href="#" onclick="showSection('farmers')" class="btn btn-primary">
                        <i class="fas fa-users"></i> Join Community
                    </a>
                    <a href="#" onclick="showSection('queries')" class="btn btn-secondary">
                        <i class="fas fa-question-circle"></i> Ask Question
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Farmers Section -->
    <section id="farmers" class="section">
        <div class="container">
            <h2 class="section-title">Farmers Community</h2>
            
            <div class="card">
                <h3>Add New Farmer</h3>
                <form id="farmerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Name</label>
                            <input type="text" id="farmerName" placeholder="Enter farmer's name" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> Location</label>
                            <input type="text" id="farmerLocation" placeholder="Village, District, State" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-language"></i> Language</label>
                            <select id="farmerLanguage" required>
                                <option value="">Select Language</option>
                                <option value="Hindi">Hindi</option>
                                <option value="English">English</option>
                                <option value="Punjabi">Punjabi</option>
                                <option value="Marathi">Marathi</option>
                                <option value="Tamil">Tamil</option>
                                <option value="Telugu">Telugu</option>
                                <option value="Bengali">Bengali</option>
                                <option value="Gujarati">Gujarati</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-seedling"></i> Field Size (acres)</label>
                            <input type="number" id="farmerFieldSize" placeholder="Enter field size" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-phone"></i> Contact</label>
                            <input type="text" id="farmerContact" placeholder="Mobile number" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Farmer
                    </button>
                </form>
            </div>

            <div class="search-filter">
                <input type="text" class="search-box" placeholder="üîç Search farmers..." id="farmerSearch">
                <select class="filter-select" id="farmerLocationFilter">
                    <option value="">All Locations</option>
                </select>
            </div>

            <div class="grid" id="farmersGrid">
                <!-- Farmers will be populated here -->
            </div>
        </div>
    </section>

    <!-- Crops Section -->
    <section id="crops" class="section">
        <div class="container">
            <h2 class="section-title">Crop Types</h2>
            
            <div class="card">
                <h3>Add New Crop Type</h3>
                <form id="cropForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Crop Name</label>
                            <input type="text" id="cropName" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="cropCategory" required>
                                <option value="">Select Category</option>
                                <option value="Grains">Grains</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Fruits">Fruits</option>
                                <option value="Legumes">Legumes</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Crop</button>
                </form>
            </div>

            <div class="grid" id="cropsGrid">
                <!-- Crops will be populated here -->
            </div>
        </div>
    </section>

    <!-- Queries Section -->
    <section id="queries" class="section">
        <div class="container">
            <h2 class="section-title">Farmer Queries</h2>
            
            <div class="card">
                <h3>Post New Query</h3>
                <form id="queryForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="queryTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Crop Type</label>
                            <select id="queryCropType" required>
                                <option value="">Select Crop</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="queryDescription" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" id="queryImage" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Post Query</button>
                </form>
            </div>

            <div class="search-filter">
                <input type="text" class="search-box" placeholder="Search queries..." id="querySearch">
                <select class="filter-select" id="queryCropFilter">
                    <option value="">All Crops</option>
                </select>
            </div>

            <div id="queriesGrid">
                <!-- Queries will be populated here -->
            </div>

            <div class="card" style="margin-top:2rem;">
                <h3>Add Response</h3>
                <form id="responseForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Query</label>
                            <select id="responseQuery" required>
                                <option value="">Select Query</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Responder</label>
                            <select id="responseResponder" required>
                                <option value="">Select Responder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Expert?</label>
                            <select id="responseIsExpert">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Response Text</label>
                        <textarea id="responseText" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Response</button>
                </form>
            </div>

            <div class="grid" id="responsesGrid">
                <!-- Responses will be populated here -->
            </div>
        </div>
    </section>

    <!-- Equipment Section -->
    <section id="equipment" class="section">
        <div class="container">
            <h2 class="section-title">Equipment</h2>
            
            <div class="card">
                <h3>Add New Equipment</h3>
                <form id="equipmentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Equipment Name</label>
                            <input type="text" id="equipmentName" required>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="equipmentType" required>
                                <option value="">Select Type</option>
                                <option value="Tractor">Tractor</option>
                                <option value="Harvester">Harvester</option>
                                <option value="Plough">Plough</option>
                                <option value="Sprayer">Sprayer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Condition</label>
                            <select id="equipmentCondition" required>
                                <option value="">Select Condition</option>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Hourly Rate ($)</label>
                            <input type="number" id="equipmentRate" required>
                        </div>
                        <div class="form-group">
                            <label>Availability</label>
                            <select id="equipmentAvailability" required>
                                <option value="Available">Available</option>
                                <option value="Unavailable">Unavailable</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Equipment</button>
                </form>
            </div>

            <div class="search-filter">
                <input type="text" class="search-box" placeholder="Search equipment..." id="equipmentSearch">
                <select class="filter-select" id="equipmentTypeFilter">
                    <option value="">All Types</option>
                    <option value="Tractor">Tractor</option>
                    <option value="Harvester">Harvester</option>
                    <option value="Plough">Plough</option>
                    <option value="Sprayer">Sprayer</option>
                </select>
            </div>

            <div class="grid" id="equipmentGrid">
                <!-- Equipment will be populated here -->
            </div>
        </div>
    </section>

    <!-- Lending Section -->
    <section id="lending" class="section">
        <div class="container">
            <h2 class="section-title">Equipment Lending</h2>
            
            <div class="card">
                <h3>Request Equipment</h3>
                <form id="lendingForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Equipment</label>
                            <select id="lendingEquipment" required>
                                <option value="">Select Equipment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Borrower</label>
                            <select id="lendingBorrower" required>
                                <option value="">Select Borrower</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lender</label>
                            <select id="lendingLender" required>
                                <option value="">Select Lender</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="lendingStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>Duration (days)</label>
                            <input type="number" id="lendingDuration" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </form>
            </div>

            <div class="grid" id="lendingGrid">
                <!-- Lending requests will be populated here -->
            </div>
        </div>
    </section>

    <!-- Reviews Section -->
    <section id="reviews" class="section">
        <div class="container">
            <h2 class="section-title">Reviews & Feedback</h2>
            
            <div class="card">
                <h3>Add Review</h3>
                <form id="reviewForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>From (Reviewer)</label>
                            <select id="reviewFrom" required>
                                <option value="">Select Farmer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>To (Review Target)</label>
                            <select id="reviewTo" required>
                                <option value="">Select Farmer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="reviewType" required>
                                <option value="Farmer">Farmer</option>
                                <option value="Equipment">Equipment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rating</label>
                            <select id="reviewRating" required>
                                <option value="">Select</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Feedback</label>
                        <textarea id="reviewFeedback" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            </div>

            <div class="grid" id="reviewsGrid">
                <!-- Reviews will be populated here -->
            </div>
        </div>
    </section>

    <!-- Auth/Profile Section -->
    <section id="auth" class="section">
        <div class="container">
            <h2 class="section-title">Login / Profile</h2>

            <div class="card" id="authCard">
                <h3>Sign In or Create Account</h3>
                <form id="authForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="authEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="authPassword" minlength="6" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <button type="button" id="signupBtn" class="btn btn-secondary" style="margin-left:1rem;">Sign Up</button>
                </form>
            </div>

            <div class="card" id="profileCard" style="display:none;">
                <h3>Your Profile</h3>
                <form id="profileForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="profileName" required>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="profileLocation">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" id="profilePhone">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                    <button type="button" id="logoutBtn" class="btn btn-secondary" style="margin-left:1rem;">Logout</button>
                </form>
            </div>
        </div>
    </section>

    <script>
        // ==========================
        // FIREBASE INIT
        // ==========================
        const firebaseConfig = {
            apiKey: "AIzaSyDLF4rsoR9Cyn1Q52idPiHAxbwb7MG_4Hw",
            authDomain: "agridbms.firebaseapp.com",
            projectId: "agridbms",
            storageBucket: "agridbms.appspot.com",
            messagingSenderId: "1024691009915",
            appId: "1:1024691009915:web:9d821137f16c8debdde5de",
            measurementId: "G-XXGTL4964Y"
        };
        try {
            firebase.initializeApp(firebaseConfig);
            var auth = firebase.auth();
            var db = firebase.firestore();
        } catch (e) {
            console.warn('Firebase init skipped. Add your config to enable Auth/Firestore.');
        }
        // --- Navigation ---
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            // Auth guard: block navigation to other sections until logged in
            try {
                if (sectionName !== 'auth' && typeof auth !== 'undefined' && !auth.currentUser) {
                    document.getElementById('auth').classList.add('active');
                } else {
                    document.getElementById(sectionName).classList.add('active');
                }
            } catch (e) {
                document.getElementById(sectionName).classList.add('active');
            }

            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ==========================
        // AUTH / PROFILE LOGIC
        // ==========================
        const authForm = document.getElementById('authForm');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileForm = document.getElementById('profileForm');
        const authCard = document.getElementById('authCard');
        const profileCard = document.getElementById('profileCard');
        let currentFarmerId = null;

        function setAuthUI(user) {
            if (user) {
                authCard.style.display = 'none';
                profileCard.style.display = 'block';
                loadUserProfile(user.uid);
                // Update nav label to Profile when logged in
                const authLink = document.getElementById('authNavLink');
                if (authLink) {
                    authLink.innerHTML = '<i class="fas fa-user-circle"></i> Profile';
                }
                // Preselect logged-in user in responder and review dropdowns
                setTimeout(() => {
                    const responderSelect = document.getElementById('responseResponder');
                    const reviewFrom = document.getElementById('reviewFrom');
                    if (responderSelect) responderSelect.value = user.uid; // assumes FarmerID == uid if mapped; else leave for name match
                    if (reviewFrom) reviewFrom.value = user.uid;
                }, 300);
            } else {
                authCard.style.display = 'block';
                profileCard.style.display = 'none';
                // Update nav label to Login when logged out
                const authLink = document.getElementById('authNavLink');
                if (authLink) {
                    authLink.innerHTML = '<i class="fas fa-user-circle"></i> Login';
                }
            }
        }

        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged(user => setAuthUI(user));
        }

        authForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            if (!auth) { alert('Firebase not configured.'); return; }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                alert('Logged in');
                // After login, ensure a Farmers row exists and redirect to Farmers
                await ensureFarmerExistsAndSetDefaults();
                showSection('farmers');
            } catch (err) {
                alert(err.message);
            }
        });

        signupBtn?.addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            if (!auth) { alert('Firebase not configured.'); return; }
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('profiles').doc(cred.user.uid).set({
                    email,
                    name: '',
                    location: '',
                    phone: ''
                });
                alert('Account created');
                await ensureFarmerExistsAndSetDefaults();
                showSection('farmers');
            } catch (err) {
                alert(err.message);
            }
        });

        async function ensureFarmerExistsAndSetDefaults() {
            try {
                const user = auth.currentUser;
                if (!user) return;
                // Try to find farmer by contact_info = email
                const res = await fetch('/get_farmers');
                const farmers = await res.json();
                let currentFarmer = farmers.find(f => f.contact_info === user.email);

                // If not found, create a farmer with minimal info
                if (!currentFarmer) {
                    const payload = {
                        name: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                        location: '',
                        language: 'English',
                        field_size: 0,
                        contact_info: user.email || ('uid:' + user.uid)
                    };
                    const addRes = await fetch('/add_farmer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    await addRes.json();
                    // Reload farmers to capture new ID
                    const res2 = await fetch('/get_farmers');
                    const farmers2 = await res2.json();
                    currentFarmer = farmers2.find(f => f.contact_info === payload.contact_info);
                }

                // Default dropdowns and set currentFarmerId
                if (currentFarmer && currentFarmer.FarmerID) {
                    const responderSelect = document.getElementById('responseResponder');
                    const reviewFrom = document.getElementById('reviewFrom');
                    if (responderSelect) responderSelect.value = currentFarmer.FarmerID;
                    if (reviewFrom) reviewFrom.value = currentFarmer.FarmerID;
                    currentFarmerId = currentFarmer.FarmerID;
                }
            } catch (e) {
                console.warn('ensureFarmerExists error', e);
            }
        }

        logoutBtn?.addEventListener('click', async () => {
            if (!auth) { return; }
            await auth.signOut();
            alert('Logged out');
        });

        async function loadUserProfile(uid) {
            if (!db) { return; }
            const doc = await db.collection('profiles').doc(uid).get();
            if (doc.exists) {
                const p = doc.data();
                document.getElementById('profileName').value = p.name || '';
                document.getElementById('profileLocation').value = p.location || '';
                document.getElementById('profilePhone').value = p.phone || '';
            }
        }

        profileForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth || !db) { alert('Firebase not configured.'); return; }
            const user = auth.currentUser;
            if (!user) { alert('Not logged in'); return; }
            const profile = {
                name: document.getElementById('profileName').value,
                location: document.getElementById('profileLocation').value,
                phone: document.getElementById('profilePhone').value,
                email: user.email
            };
            await db.collection('profiles').doc(user.uid).set(profile, { merge: true });
            alert('Profile saved');
        });

        // ==========================
        // FARMERS SECTION
        // ==========================
        document.getElementById('farmerForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const farmer = {
                name: document.getElementById('farmerName').value,
                location: document.getElementById('farmerLocation').value,
                language: document.getElementById('farmerLanguage').value,
                field_size: document.getElementById('farmerFieldSize').value,
                contact_info: document.getElementById('farmerContact').value
            };

            let res = await fetch('/add_farmer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(farmer)
            });
            let result = await res.json();
            alert(result.message);
            loadFarmers();
            e.target.reset();
        });

        async function loadFarmers() {
            let res = await fetch('/get_farmers');
            let farmers = await res.json();
            const grid = document.getElementById('farmersGrid');
            grid.innerHTML = farmers.map(farmer => `
                <div class="profile-card">
                    <div class="profile-avatar"><i class="fas fa-user-tie"></i></div>
                    <h3>${farmer.name}</h3>
                    <p><i class="fas fa-map-marker-alt"></i> ${farmer.location}</p>
                    <p><i class="fas fa-language"></i> ${farmer.language}</p>
                    <p><i class="fas fa-seedling"></i> ${farmer.field_size} acres</p>
                    <p><i class="fas fa-phone"></i> ${farmer.contact_info}</p>
                </div>
            `).join('');

            // Populate response responder dropdown
            const responderSelect = document.getElementById('responseResponder');
            if (responderSelect) {
                responderSelect.innerHTML = '<option value="">Select Responder</option>';
                farmers.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.FarmerID;
                    option.textContent = f.name;
                    responderSelect.appendChild(option);
                });
            }

            // Populate review From/To dropdowns
            const reviewFrom = document.getElementById('reviewFrom');
            const reviewTo = document.getElementById('reviewTo');
            if (reviewFrom && reviewTo) {
                reviewFrom.innerHTML = '<option value="">Select Farmer</option>';
                reviewTo.innerHTML = '<option value="">Select Farmer</option>';
                farmers.forEach(f => {
                    const a = document.createElement('option');
                    a.value = f.FarmerID;
                    a.textContent = f.name;
                    reviewFrom.appendChild(a);
                    const b = document.createElement('option');
                    b.value = f.FarmerID;
                    b.textContent = f.name;
                    reviewTo.appendChild(b);
                });
            }
        }


        // ==========================
        // CROPS SECTION
        // ==========================
        document.getElementById('cropForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const crop = {
                name: document.getElementById('cropName').value,
                category: document.getElementById('cropCategory').value
            };
            let res = await fetch('/add_crop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(crop)
            });
            let result = await res.json();
            alert(result.message);
            loadCrops();
            e.target.reset();
        });

        async function loadCrops() {
            let res = await fetch('/get_crops');
            let crops = await res.json();

            // Populate crops grid
            const grid = document.getElementById('cropsGrid');
            grid.innerHTML = crops.map(crop => `
                <div class="profile-card">
                    <div class="profile-avatar"><i class="fas fa-leaf"></i></div>
                    <h3>${crop.name}</h3>
                    <p><i class="fas fa-tag"></i> ${crop.category}</p>
                </div>
            `).join('');

            // Populate dropdowns in Queries
            const cropSelect = document.getElementById('queryCropType');
            cropSelect.innerHTML = '<option value="">Select Crop</option>';
            crops.forEach(crop => {
                const option = document.createElement('option');
                option.value = crop.CropTypeID;
                option.textContent = crop.name;
                cropSelect.appendChild(option);
            });
        }

        // ==========================
        // QUERIES SECTION
        // ==========================
        document.getElementById('queryForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('queryTitle').value);
            formData.append('description', document.getElementById('queryDescription').value);
            formData.append('FarmerID', currentFarmerId || document.getElementById('farmerSelect')?.value || 1);
            formData.append('crop_type', document.getElementById('queryCropType').value);
            const imageFile = document.getElementById('queryImage').files[0];
            if (imageFile) formData.append('image', imageFile);

            let res = await fetch('/add_query', {
                method: 'POST',
                body: formData
            });
            let result = await res.json();
            alert(result.message);
            loadQueries();
            e.target.reset();
        });

        async function loadQueries() {
            const [qRes, rRes] = await Promise.all([
                fetch('/get_queries'),
                fetch('/get_responses')
            ]);
            const queries = await qRes.json();
            const responses = await rRes.json();

            const queryIdToResponses = {};
            responses.forEach(r => {
                const key = r.QueryID;
                if (!queryIdToResponses[key]) queryIdToResponses[key] = [];
                queryIdToResponses[key].push(r);
            });

            const grid = document.getElementById('queriesGrid');
            // Map CropTypeID to name for compact badges
            const cropsRes = await fetch('/get_crops');
            const crops = await cropsRes.json();
            const cropIdToName = {};
            crops.forEach(c => { cropIdToName[c.CropTypeID] = c.name; });

            grid.innerHTML = '<div class="query-list">' + queries.map(q => {
                const resp = (queryIdToResponses[q.QueryID] || []);
                const cropBadge = q.crop_type ? `<span class="badge badge-crop">${cropIdToName[q.crop_type] || 'Crop'}</span>` : '';
                const thumb = q.image_url ? `<img src="${q.image_url}" alt="query">` : '<i class="fas fa-image" style="color:#7fb069;font-size:1.2rem;"></i>';

                const responsesHtml = resp.length ? (
                    '<div class="responses">' + resp.map(r => {
                        const role = r.is_expert ? 'Expert' : 'Farmer';
                        const roleBadge = `<span class=\"badge ${r.is_expert ? 'badge-expert' : ''}\">${role}</span>`;
                        return `
                            <div class=\"response-inline\">${roleBadge}<div>${(r.response_text || '')}</div></div>
                        `;
                    }).join('') + '</div>'
                ) : '<div style="color:#666;">No responses yet.</div>';

                return `
                <div class=\"query-card query-card--compact\">
                    <div class=\"query-thumb\">${thumb}</div>
                    <div>
                        <div class=\"query-meta-small\">${cropBadge}</div>
                        <h5 class=\"query-title-small\">${q.title}</h5>
                        ${q.description ? `<div class=\"query-subtitle\">${q.description}</div>` : ''}
                        ${responsesHtml}
                    </div>
                </div>`;
            }).join('') + '</div>';

            const responseQuery = document.getElementById('responseQuery');
            if (responseQuery) {
                responseQuery.innerHTML = '<option value="">Select Query</option>';
                queries.forEach(q => {
                    const opt = document.createElement('option');
                    opt.value = q.QueryID;
                    opt.textContent = q.title;
                    responseQuery.appendChild(opt);
                });
            }
        }

        // ==========================
        // RESPONSES SECTION
        // ==========================
        document.getElementById('responseForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const payload = {
                QueryID: document.getElementById('responseQuery').value,
                ResponderID: document.getElementById('responseResponder').value,
                response_text: document.getElementById('responseText').value,
                is_expert: document.getElementById('responseIsExpert').value === 'true',
                votes: 0
            };

            try {
                let res = await fetch('/add_response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                let result = await res.json();
                if (!res.ok) {
                    alert(result.message || 'Error adding response');
                    return;
                }
                alert(result.message);
                e.target.reset();
                loadResponses();
            } catch (err) {
                console.error(err);
                alert('Network error while adding response');
            }
        });

        async function loadResponses() {
            try {
                let res = await fetch('/get_responses');
                let responses = await res.json();
                const grid = document.getElementById('responsesGrid');
                grid.innerHTML = responses.map(r => `
                    <div class="profile-card">
                        <p><strong>Query #${r.QueryID}</strong></p>
                        <p>${r.response_text}</p>
                        <p>${r.is_expert ? 'Expert' : 'Farmer'} ‚Ä¢ Votes: ${r.votes}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // ==========================
        // EQUIPMENT SECTION
        // ==========================
        document.getElementById('equipmentForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const equipment = {
                OwnerID: currentFarmerId || document.getElementById('ownerSelect')?.value || 1,
                name: document.getElementById('equipmentName').value,
                type: document.getElementById('equipmentType').value,
                condition: document.getElementById('equipmentCondition').value,
                hourly_rate: document.getElementById('equipmentRate').value,
                availability_status: document.getElementById('equipmentAvailability').value
            };

            try {
                let res = await fetch('/add_equipment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(equipment)
                });
                let result = await res.json();
                if (!res.ok) {
                    alert(result.message || 'Error adding equipment');
                    return;
                }
                alert(result.message);
                loadEquipment();
                // Refresh lending equipment dropdown so newly added items appear
                try { await loadLendingEquipment(); } catch (e) {}
                e.target.reset();
            } catch (err) {
                console.error(err);
                alert('Network error while adding equipment');
            }
        });

        async function loadEquipment() {
            try {
                let res = await fetch('/get_equipment');
                let equipment = await res.json();
                const grid = document.getElementById('equipmentGrid');
                grid.innerHTML = equipment.map(eq => `
                    <div class="equipment-card">
                        <div class="equipment-image"><i class="fas fa-tractor"></i></div>
                        <div class="equipment-info">
                            <h4>${eq.name}</h4>
                            <p><strong>Type:</strong> ${eq.type}</p>
                            <p><strong>Condition:</strong> ${eq.condition}</p>
                            <p><strong>Rate:</strong> $${eq.hourly_rate}/hr</p>
                            <span class="status-badge ${eq.availability_status === 'Available' ? 'status-available' : 'status-unavailable'}">${eq.availability_status}</span>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }
        // ==========================
        // LENDING REQUESTS
        // ==========================

            // Populate Equipment dropdown (only available equipment)
            async function loadLendingEquipment() {
                let res = await fetch('/get_equipment');
                let equipmentList = await res.json();
                const select = document.getElementById('lendingEquipment');
                select.innerHTML = '<option value="">Select Equipment</option>';

                equipmentList.forEach(eq => {
                    if (eq.availability_status === 'Available') {
                        const option = document.createElement('option');
                        option.value = eq.EquipmentID;
                        option.textContent = `${eq.name} (${eq.type})`;
                        select.appendChild(option);
                    }
                });
            }

            // Populate Borrower dropdown (all farmers)
            async function loadLendingBorrowers() {
                let res = await fetch('/get_farmers');
                let farmers = await res.json();
                const select = document.getElementById('lendingBorrower');
                select.innerHTML = '<option value="">Select Borrower</option>';

                farmers.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.FarmerID;
                    option.textContent = f.name;
                    select.appendChild(option);
                });
            }

            async function loadFarmersForLending() {
                    let res = await fetch('/get_farmers');
                    let farmers = await res.json();
                    const borrowerSelect = document.getElementById('lendingBorrower');
                    borrowerSelect.innerHTML = '<option value="">Select Borrower</option>';
                    farmers.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.FarmerID;  // ‚úÖ send ID, not name
                        option.textContent = f.name;
                        borrowerSelect.appendChild(option);
                    });

                    const lenderSelect = document.getElementById('lendingLender');
                    lenderSelect.innerHTML = '<option value="">Select Lender</option>';
                    farmers.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.FarmerID;  // ‚úÖ send ID
                        option.textContent = f.name;
                        lenderSelect.appendChild(option);
                    });
            }

            // Remove earlier duplicate submit handler and use a single, validated one below


            // Handle Lending Request submission
            document.getElementById('lendingForm')?.addEventListener('submit', async function (e) {
                e.preventDefault();

                const EquipmentID = document.getElementById('lendingEquipment').value;
                const BorrowerID = currentFarmerId || document.getElementById('lendingBorrower').value;
                const LenderID = document.getElementById('lendingLender').value;
                const start_date = document.getElementById('lendingStartDate').value;
                const duration = document.getElementById('lendingDuration').value;

                if (!EquipmentID || !BorrowerID || !LenderID) {
                    alert('Please select equipment, lender, and borrower.');
                    return;
                }

                const requestData = { EquipmentID, BorrowerID, LenderID, start_date, duration };

                try {
                    let res = await fetch('/add_lending_request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                    let result = await res.json();
                    if (!res.ok) {
                        alert(result.message || 'Error submitting lending request');
                        return;
                    }
                    alert(result.message);
                    e.target.reset();
                    loadLendingEquipment();
                    loadLendingRequestsUI();
                } catch (err) {
                    console.error(err);
                    alert('Error submitting lending request.');
                }
            });

            // Load dropdowns on page load
            document.addEventListener('DOMContentLoaded', () => {
                loadLendingEquipment();
                loadLendingBorrowers();
                loadFarmersForLending();
            });



        // ==========================
        // REVIEWS SECTION
        // ==========================
        document.getElementById('reviewForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const review = {
                FromFarmerID: document.getElementById('reviewFrom').value,
                ToFarmerID: document.getElementById('reviewTo').value,
                rating: document.getElementById('reviewRating').value,
                feedback: document.getElementById('reviewFeedback').value,
                type: document.getElementById('reviewType').value
            };

            let res = await fetch('/add_review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(review)
            });
            let result = await res.json();
            alert(result.message);
            loadReviews();
            e.target.reset();
        });

        async function loadReviews() {
            let res = await fetch('/get_reviews');
            let reviews = await res.json();
            const grid = document.getElementById('reviewsGrid');
            grid.innerHTML = reviews.map(r => `
                <div class="profile-card">
                    <p><strong>Type:</strong> ${r.type}</p>
                    <p><strong>From:</strong> ${r.FromFarmerID} <strong>To:</strong> ${r.ToFarmerID}</p>
                    <p><strong>Rating:</strong> ${r.rating}</p>
                    <p>${r.feedback}</p>
                </div>
            `).join('');
        }

        async function loadLendingEquipment() {
                let res = await fetch('/get_equipment'); // Endpoint that returns all equipment
                let equipmentList = await res.json();

                const select = document.getElementById('lendingEquipment');
                select.innerHTML = '<option value="">Select Equipment</option>'; // reset

                equipmentList.forEach(eq => {
                    if (eq.availability_status === 'Available') { // only show available
                        const option = document.createElement('option');
                        option.value = eq.EquipmentID;  // backend ID
                        option.textContent = `${eq.name} (${eq.type})`;
                        select.appendChild(option);
                    }
                });
            }
        // ==========================
        // ON PAGE LOAD
        // ==========================
        document.addEventListener("DOMContentLoaded", () => {
            loadFarmers();
            loadCrops();
            loadQueries();
            loadEquipment();
            loadReviews();
            loadLendingEquipment();
            loadLendingRequestsUI();
            // If Firebase auth is available and user not logged in, show auth first
            try {
                if (typeof auth !== 'undefined' && !auth.currentUser) {
                    showSection('auth');
                }
            } catch (e) {}
        });

        async function loadLendingRequestsUI() {
            try {
                const res = await fetch('/get_lending_requests');
                const reqs = await res.json();
                const grid = document.getElementById('lendingGrid');
                if (!grid) return;
                grid.innerHTML = reqs.map(r => {
                    const isOwner = currentFarmerId && Number(r.LenderID) === Number(currentFarmerId);
                    const isBorrower = currentFarmerId && Number(r.BorrowerID) === Number(currentFarmerId);
                    const canAct = isOwner && r.status === 'Pending';
                    const actions = canAct ? `
                        <div style="display:flex;gap:.5rem;margin-top:.5rem;">
                            <button class="btn btn-primary" style="padding:.4rem .8rem;border-radius:16px;" onclick="updateLendingStatus(${r.RequestID}, 'Approved')">Accept</button>
                            <button class="btn btn-secondary" style="padding:.4rem .8rem;border-radius:16px;" onclick="updateLendingStatus(${r.RequestID}, 'Rejected')">Reject</button>
                        </div>
                    ` : '';
                    const badgeClass = r.status === 'Pending' ? 'status-pending' : (r.status === 'Approved' ? 'status-available' : 'status-unavailable');
                    return `
                        <div class="profile-card" style="text-align:left;">
                            <h4 style="margin-bottom:.5rem;">${r.equipment_name}</h4>
                            <p><strong>Lender:</strong> ${r.lender_name} (#${r.LenderID})</p>
                            <p><strong>Borrower:</strong> ${r.borrower_name} (#${r.BorrowerID})</p>
                            <p><strong>Duration:</strong> ${r.duration} days</p>
                            <span class="status-badge ${badgeClass}">${r.status}</span>
                            ${actions}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('loadLendingRequestsUI error', e);
            }
        }

        async function updateLendingStatus(requestId, status) {
            try {
                const res = await fetch('/update_lending_request_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ RequestID: requestId, status })
                });
                const result = await res.json();
                if (!res.ok) { alert(result.message || 'Update failed'); return; }
                loadLendingRequestsUI();
            } catch (e) {
                console.error(e);
                alert('Network error');
            }
        }
    </script>


</body>
</html>
